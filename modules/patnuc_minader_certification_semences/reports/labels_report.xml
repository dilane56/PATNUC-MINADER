<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Action pour le rapport d'étiquettes -->
    <record id="action_labels_report" model="ir.actions.report">
        <field name="name">Étiquettes de semences</field>
        <field name="model">labelling.request</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">patnuc_minader_certification_semences.labels_report_template</field>
        <field name="report_file">patnuc_minader_certification_semences.labels_report_template</field>
    </record>

    <!-- Template du rapport -->
    <template id="labels_report_template">
        <!-- Styles placés une seule fois (hors des boucles) -->
        <t t-set="global_style">
            <style type="text/css">
                /* Page */
                @page {
                    size: A4;
                    margin: 8.5mm 4.6mm; /* top/bottom 8.5mm, left/right 4.6mm */
                }
                html, body {
                    width: 210mm;
                    height: 297mm;
                    margin: 0;
                    padding: 0;
                }
                .page {
                    width: 210mm;
                    height: 297mm;
                    box-sizing: border-box;
                    position: relative;
                }

                /* Conteneur global des étiquettes sur la page.
                   On évite toute coupure à l'intérieur du conteneur. */
                .label-container {
                    width: 100%;
                    height: 100%;
                    box-sizing: border-box;
                    /* empêcher les coupures à l'intérieur du container */
                    page-break-inside: avoid !important;
                    break-inside: avoid !important;
                    -webkit-column-break-inside: avoid !important;
                }

                /* Ligne contenant deux labels.
                   hauteur fixe : 38.1mm (Avery L7163) */
                .label-row {
                    width: 100%;
                    height: 38.1mm;
                    box-sizing: border-box;
                    margin: 0;
                    padding: 0;
                    /* éviter la coupure au milieu d'une ligne */
                    page-break-inside: avoid !important;
                    break-inside: avoid !important;
                    display: block;
                    clear: both;
                }

                /* Étiquette (colonne) :
                   99.1mm x 38.1mm, float:left pour stabilité wkhtmltopdf */
                .label-item {
                    width: 99.1mm;
                    height: 38.1mm;
                    box-sizing: border-box;
                    float: left;
                    border: 1px solid #000;
                    padding: 2mm;
                    font-size: 8px;
                    line-height: 1.1;
                    position: relative;
                    overflow: hidden; /* empêche débordement et coupe nette */
                    display: block;
                    margin: 0;
                }
                /* espacement entre colonnes */
                .label-item.left {
                    margin-right: 2.5mm;
                }
                /* espace réservé quand pas d'étiquette (garde la place) */
                .label-empty {
                    width: 99.1mm;
                    height: 38.1mm;
                    float: left;
                    box-sizing: border-box;
                    margin: 0;
                    padding: 0;
                }

                /* header/content/footer de la vignette */
                .label-header {
                    text-align: center;
                    font-weight: bold;
                    font-size: 9px;
                    border-bottom: 1px solid #000;
                    padding-bottom: 1mm;
                    margin-bottom: 1mm;
                    height: 8mm;
                    box-sizing: border-box;
                }
                .label-content {
                    height: 22mm; /* espace alloué au contenu ; ajuste si besoin */
                    box-sizing: border-box;
                    overflow: hidden;
                }
                .label-footer {
                    text-align: center;
                    font-weight: bold;
                    font-size: 7px;
                    border-top: 1px solid #000;
                    padding-top: 1mm;
                    height: 4mm;
                    box-sizing: border-box;
                    position: absolute;
                    bottom: 2mm;
                    left: 2mm;
                    right: 2mm;
                }

                .label-field {
                    margin-bottom: 0.4mm;
                    font-size: 8px;
                }
                .label-field strong {
                    font-size: 7px;
                }
                .label-value {
                    font-size: 8px;
                    font-weight: bold;
                }

                /* Force stricte pour wkhtmltopdf */
                .label-row, .label-item, .label-container {
                    -webkit-print-color-adjust: exact;
                }
            </style>
        </t>

        <!-- Appel du container HTML d'Odoo -->
        <t t-call="web.html_container">
            <!-- Injecte le style (une seule fois) -->
            <t t-raw="global_style"/>

            <t t-foreach="docs" t-as="doc">
                <!-- On suppose que doc.get_labels_by_pages() renvoie une liste de pages,
                     chaque page étant une liste d'objets/labels pour cette page -->
                <t t-set="pages" t-value="doc.get_labels_by_pages()"/>
                <t t-foreach="pages" t-as="page">
                    <div class="page">
                        <div class="label-container">
                            <!-- Parcours par paires : 0-1, 2-3, ... -->
                            <t t-foreach="range(0, len(page), 2)" t-as="row_index">
                                <div class="label-row">
                                    <!-- étiquette gauche -->
                                    <t t-if="page[row_index]">
                                        <t t-set="label1" t-value="page[row_index]"/>
                                        <div class="label-item left">
                                            <div class="label-header">
                                                REPUBLIQUE DU CAMEROUN<br/>
                                                ETIQUETTE DE SEMENCE CERTIFIEE
                                            </div>
                                            <div class="label-content">
                                                <div class="label-field">
                                                    <strong>Espece/Species:</strong><br/>
                                                    <span class="label-value" t-esc="label1.espece"/>
                                                </div>
                                                <div class="label-field">
                                                    <strong>Variete/Variety:</strong><br/>
                                                    <span class="label-value" t-esc="label1.variete"/>
                                                </div>
                                                <div class="label-field">
                                                    <strong>Lot N°:</strong>
                                                    <span class="label-value" t-esc="label1.lot_name"/>
                                                </div>
                                                <div class="label-field">
                                                    <strong>Poids net:</strong>
                                                    <span class="label-value" t-esc="label1.poids_net"/> kg
                                                </div>
                                                <div class="label-field">
                                                    <strong>Lieu:</strong>
                                                    <span class="label-value" t-esc="label1.lieu_production"/>
                                                </div>
                                                <div class="label-field">
                                                    <strong>Annee:</strong>
                                                    <span class="label-value" t-esc="label1.annee_production"/>
                                                </div>
                                            </div>
                                            <div class="label-footer">
                                                SEMENCES CERTIFIEES
                                            </div>
                                        </div>
                                    </t>
                                    <t t-else="">
                                        <div class="label-empty"/>
                                    </t>

                                    <!-- étiquette droite -->
                                    <t t-if="row_index + 1 &lt; len(page) and page[row_index + 1]">
                                        <t t-set="label2" t-value="page[row_index + 1]"/>
                                        <div class="label-item">
                                            <div class="label-header">
                                                REPUBLIQUE DU CAMEROUN<br/>
                                                ETIQUETTE DE SEMENCE CERTIFIEE
                                            </div>
                                            <div class="label-content">
                                                <div class="label-field">
                                                    <strong>Espece/Species:</strong><br/>
                                                    <span class="label-value" t-esc="label2.espece"/>
                                                </div>
                                                <div class="label-field">
                                                    <strong>Variete/Variety:</strong><br/>
                                                    <span class="label-value" t-esc="label2.variete"/>
                                                </div>
                                                <div class="label-field">
                                                    <strong>Lot N°:</strong>
                                                    <span class="label-value" t-esc="label2.lot_name"/>
                                                </div>
                                                <div class="label-field">
                                                    <strong>Poids net:</strong>
                                                    <span class="label-value" t-esc="label2.poids_net"/> kg
                                                </div>
                                                <div class="label-field">
                                                    <strong>Lieu:</strong>
                                                    <span class="label-value" t-esc="label2.lieu_production"/>
                                                </div>
                                                <div class="label-field">
                                                    <strong>Annee:</strong>
                                                    <span class="label-value" t-esc="label2.annee_production"/>
                                                </div>
                                            </div>
                                            <div class="label-footer">
                                                SEMENCES CERTIFIEES
                                            </div>
                                        </div>
                                    </t>
                                    <t t-else="">
                                        <div class="label-empty"/>
                                    </t>

                                    <!-- Clear float pour la ligne -->
                                    <div style="clear: both;"></div>
                                </div> <!-- .label-row -->
                            </t> <!-- foreach range -->
                        </div> <!-- .label-container -->

                        <!-- Saut de page sauf pour la dernière page -->
                        <div style="page-break-after: always;" t-if="not page_last"></div>
                    </div> <!-- .page -->
                </t> <!-- foreach pages -->
            </t> <!-- foreach docs -->
        </t> <!-- web.html_container -->
    </template>
</odoo>
