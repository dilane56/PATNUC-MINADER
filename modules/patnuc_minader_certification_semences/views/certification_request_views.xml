<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Vue formulaire pour demande de certification -->
    <record id="view_certification_request_form" model="ir.ui.view">
        <field name="name">certification.request.form</field>
        <field name="model">certification.request</field>
        <field name="arch" type="xml">
            <form string="Demande de Certification">
                <header>
                    <!-- CORRECTION : Ajout du champ has_lab_report pour les attributs 'invisible' -->
                    <field name="has_lab_report" invisible="1"/>

                    <!-- BOUTONS PRINCIPAUX DU WORKFLOW -->
                    <button name="action_submit" string="Soumettre" type="object" class="btn-primary" invisible="state != 'draft'"/>
                    <button name="action_verified_documents" string="Valider verification" type="object" class="btn-primary" invisible="state != 'doc_verification'"/>
                    <button name="action_open_lot_form" string="Créer un lot" type="object" class="btn-primary" invisible="state !='inspection'"/>

<!--                    <button name="action_start_inspection" string="Démarrer Inspection" type="object" class="btn-info" invisible="state != 'inspection'"/>-->
                    <button name="action_complete_field_inspection" string="Terminer Inspection" type="object" class="btn-info" invisible="state != 'inspection'" 
                            confirm="Êtes-vous sûr de vouloir terminer l'inspection ? Toutes les conditions doivent être remplies (lots créés, 3 inspections terminées par lot, rapport final avec décision)."/>
                    
                        <!-- ACTIONS ET VALIDATION ÉCHANTILLONNAGE (MISES À JOUR) -->
                    <button name="action_start_sampling_form" string="Créer Analyse Labo" type="object" class="btn-info" invisible="state != 'sampling' or has_lab_report"/>
                    <button name="action_start_sampling_form" string="Voir Analyse Labo" type="object" class="btn-info" invisible="state != 'sampling' or not has_lab_report"/>
                    <button name="action_complete_sampling" string="Terminer Échantillonnage" type="object" class="btn-success" invisible="state != 'sampling'"
                            confirm="Êtes-vous sûr de vouloir valider l'étape Échantillonnage ? Tous les lots doivent avoir une analyse de prélèvement terminée et le rapport général validé."/>
                    
                    <button name="action_approve"
                        string="Approuver la Certification"
                        type="object"
                        class="btn-success"
                        icon="fa-check"
                        invisible="state != 'labelling'"/>
                    <button name="action_complete_certification" string="Terminer Certification" type="object" class="btn-info" invisible="state != 'certification'"/>
                   
                      <!-- BOUTONS DE RETOUR (secondaires) -->
                    <button name="action_return_to_draft" string="Retour" type="object" class="btn-warning" invisible="state != 'doc_verification'"/>
                    <button name="action_back_to_doc_verification" string="Retour" type="object" class="btn-warning" invisible="state != 'inspection'"/>
                    <button name="action_back_to_inspection" string="Retour" type="object" class="btn-warning" invisible="state != 'sampling'"/>
                    <button name="action_back_to_sampling" string="Retour" type="object" class="btn-warning" invisible="state != 'certification'"/>
                    <button name="action_back_to_certification" string="Retour" type="object" class="btn-warning" invisible="state != 'labelling'"/>

                    
                    <!-- BOUTONS D'ACTION -->
                    <button name="action_reject" string="Rejeter" type="object" class="btn-danger" invisible="state in ['draft', 'labelling', 'rejected', 'cancelled','doc_verification']"/>
                    <button name="action_cancel" string="Annuler" type="object" class="btn-danger" invisible="state in ['labelling', 'rejected', 'cancelled','doc_verification','inspection']"
                        confirm="Êtes-vous sûr de vouloir annuler cette demande ?"/>
                    <button name="action_reset_to_draft" string="Remettre en brouillon" type="object" class="btn-warning" invisible="state not in ['rejected', 'cancelled']"/>
                    
                    <field name="state" widget="statusbar" statusbar_visible="draft,doc_verification,inspection,sampling,certification,labelling,approved"/>
                </header>
                <sheet>
                    <field name="all_documents_verified" invisible="1"/>
<!--                    <field name="verification_note" invisible="1"/>-->
                    <div class="oe_title">
                        <h1>
                            <field name="name" readonly="1"/>
                        </h1>
                    </div>
                    <group col="4">
                        <group colspan="2">
                            <field name="operator_id" options="{'no_create': True}" readonly="state !='draft'"/>
                            <field name="region_id" readonly="1"/>
                            <field name="departement_id" domain="[('region_id', '=', region_id)]" readonly="1"/>
                            <field name="arrondissement_id" domain="[('departement_id', '=', departement_id)]" readonly="1"/>
                            <field name="localite_id" readonly="1"/>

                        </group>
                        <group colspan="2">

                            <field name="parcelle_id" domain="[('operator_id', '=', operator_id), ('request_id', '=', False)]" options="{'no_create': True}" readonly="state != 'draft'"/>
                            <field name="agricole_campain" readonly="state !='draft'"/>
                            <field name="encadrement_structure" readonly="state !='draft'"/>
                            <field name="submission_date" readonly="1"/>
                            <field name="return_reason" invisible=" not return_reason" readonly="1"/>

                        </group>
                    </group>
                    <notebook>
                        <page string="Informations générales et documents requis">
                            <group>
                                  <group string="Informations sur l'opérateur" >
                                        <field name="operator_name" readonly="1" string="Nom complet"/>
                                        <field name="operator_email" readonly="1" string="Email"/>
                                        <field name="operator_phone" />
                                       <field name="operator_statut"/>
                                        <field name="operator_raison_sociale"/>
                                 </group>
                            <group string="Documents requis" >
                                 <field name="declaration_activite_semenciere_timbre" filename="declaration_activite_semenciere_timbre_filename"/>
                                    <field name="declaration_activite_semenciere_timbre_filename" placeholder="Nom du fichier uploadé" invisible="1"/>
                                    <field name="redevance_semenciere_payement_receipt" filename="redevance_semenciere_payement_receipt_filename"/>
                                    <field name="redevance_semenciere_payement_receipt_filename" placeholder="Nom du fichier uploadé" invisible="1"/>

                            </group>
                            </group>

                        </page>
                        <page string="Détails de la parcelle" invisible="not parcelle_id">
                            <group col="4">
                                <group colspan="2" string="Informations de base">
                                    <field name="parcelle_espece" readonly="1"/>
                                    <field name="parcelle_variete" readonly="1"/>
                                    <field name="parcelle_superficie" readonly="1"/>
                                    <field name="parcelle_qte_sem_meres" readonly="1"/>
                                    <field name="parcelle_production" readonly="1"/>
                                    <field name="region_id" readonly="1"/>
                                    <field name="departement_id" readonly="1"/>
                                    <field name="arrondissement_id" readonly="1"/>
                                    <field name="localite_id" readonly="1"/>
                                    <field name="parcelle_categorie" readonly="1"/>
                                </group>
                                <group colspan="2" string="Résumé des frais de redevance semencière">
                                    <group >
                                        <field name="parcelle_superficie" readonly="1" string="Superficie déclarée (ha)"/>
                                        <div class="o_form_label">Tarif: 10 000 FCFA / hectare</div>
                                    </group>
                                     <group >
                                        <field name="parcelle_frais" readonly="1"  options="{'currency_field': False}" string="Total à payer (FCFA)"/>
                                    </group>
                                    <field name="parcelle_frais" readonly="1" widget="monetary" options="{'currency_field': False}"/>
                                </group>
                            </group>
                        </page>
                        <page string="Vérification des documents" invisible="state == 'draft'">
                            <group >
                                <group string="Vérification des documents" >
                                    <group>
                                        <label string="Declaration d'activite semencière timbré" for="declaration_activite_semenciere_verified"/>
                                        <field name="declaration_activite_semenciere_verified" readonly="state != 'doc_verification'" nolabel="1"/>
                                        <label string="Recu de payement des frais de redevance Semencière" for="payement_receipt_verified"/>
                                        <field name="payement_receipt_verified" readonly="state != 'doc_verification'" nolabel="1"/>
                                    </group>
                                    <group style="display: flex; flex-direction: column; gap: 20px" >
                                        <button name="preview_document" string="Prévisualiser" type="object" class="oe_highlight" context="{'document_field': 'declaration_activite_semenciere_timbre'}" invisible="not declaration_activite_semenciere_timbre or state  in ('draft','rejected')" />
                                        <button name="preview_document" string="Prévisualiser" type="object" class="oe_highlight" context="{'document_field': 'redevance_semenciere_payement_receipt'}" invisible="not redevance_semenciere_payement_receipt or state  in ('draft','rejected')"/>
                                    </group>

                                </group>
                                <group string="Informations supplementaire sur la verification">
                                   <field name="documents_verfication_date" readonly="1"/>
                                    <field name="documents_verfication_agent" readonly="1"/>
                                    <field name="documents_verfication_comment" readonly="state != 'doc_verification'"/>
                                </group>
                            </group>
                        </page>
                        <page string="Inspections terrain" invisible="state not in ['inspection', 'sampling', 'certification', 'labelling']">
                            <group string="Résumé des inspections par lot" col="4">
                                <group colspan="2">
                                    <field name="total_lots_count" readonly="1" string="Nombre total de lots"/>
                                    <field name="min_inspections_required" readonly="1" string="Inspections requises par lot"/>
                                    <field name="inspection_progress" readonly="1" string="Progression globale"/>
                                </group>
                                <group colspan="2">
                                    <field name="lots_with_enough_inspections" readonly="1" string="Lots avec ≥3 inspections"/>
                                    <field name="lots_completed" readonly="1" string="Lots avec inspections terminées"/>
                                    <field name="all_lots_inspection_complete" readonly="1" string="Toutes inspections terminées" widget="boolean"/>
                                </group>
                            </group>
                            
                            <group string="Lots de production">
                                <field name="lot_ids" readonly="state !='inspection'">
                                    <tree>
                                        <field name="name"/>
                                        <field name="area"/>
                                        <field name="inspections_count"/>
<!--                                        <field name="state"/>-->
                                    </tree>
                                </field>
                            </group>
                            
                            <group string="Détail des inspections par lot">
                                <field name="inspection_ids" readonly="state !='inspection'" >
                                    <tree>
                                        <field name="name"/>
                                        <field name="lot_id"/>
                                        <field name="inspector_id"/>
                                        <field name="scheduled_date"/>
                                        <field name="visit_stage"/>
                                        <field name="state"/>
                                        <field name="conclusion"/>
                                    </tree>
                                </field>
                            </group>
                            
                            <group string="Rapport final d'inspection" invisible="not all_lots_inspection_complete" col="4">
                                <group colspan="2" string="Informations du rapport">
                                    <field name="final_inspection_report_id" readonly="1"/>
                                    <field name="has_final_report" readonly="1" widget="boolean" string="Rapport créé"/>
                                    <field name="final_report_decision" readonly="1" string="Décision finale"/>
                                    <field name="final_report_created_by" readonly="1" invisible="not has_final_report"/>
                                    <field name="final_report_created_date" readonly="1" invisible="not has_final_report"/>
                                </group>
                                <group colspan="2" string="Actions" style="display: flex; flex-direction:column">
                                        <group>
                                            <button name="action_create_final_report" string="Créer rapport final" type="object" class="btn-primary"
                                                invisible="has_final_report or state not in ['inspection', 'sampling']"/>
                                            <button name="action_create_final_report" string="Voir/Modifier rapport" type="object" class="btn-info"
                                                invisible="not has_final_report"/>
                                        </group>
                                    <group colspan="2" style="display: flex;flex-direction: row;">
<!--                                        <label string="Pdf du rapport final " for="final_report_pdf"/>-->
                                        <field name="final_report_pdf" filename="final_report_pdf_filename" invisible="not final_report_pdf"  />
                                        <button name="preview_document" string="Prévisualiser" type="object" class="oe_highlight" context="{'document_field': 'final_report_pdf'}" invisible="not final_report_pdf or state  in ('draft','rejected','doc_verification')"/>

                                    </group>

                                </group>
                                <group colspan="4" string="Synthèse du rapport" invisible="not has_final_report">
                                    <field name="final_report_summary" readonly="1" placeholder="Synthèse du rapport final..."/>
                                </group>
                            </group>
                        </page>
                        <!-- PAGE ÉCHANTILLONNAGE ET ANALYSES (MISE À JOUR) -->
                    <page string="Échantillonnage et Analyses" invisible="state not in ['sampling', 'certification', 'labelling']">
                        <group string="Résumé des Analyses par lot" col="4">
                            <group colspan="2">
                                <field name="total_lots_count" readonly="1" string="Nombre total de lots"/>
                                <field name="analysis_lots_progress" readonly="1" string="Progression analyse lots"/>
                            </group>
                            <group colspan="2">
                                <field name="analysis_done_count" readonly="1" string="Prélèvements terminés"/>
                                <field name="all_lots_analysis_complete" readonly="1" string="Tous lots analysés" widget="boolean"/>
                                <field name="analysis_summary_compliant_lots" readonly="1" string="Lots conformes à l'analyse"/>
                            </group>
                            <group colspan="4" string="Synthèse du rapport" invisible="not labo_report_pdf">
                                    <field name="labo_report_pdf_filename" invisible="1"/>

                                    <!-- Affichage du PDF du rapport final. Le widget 'binary' gère le téléchargement. -->
                                    <field name="labo_report_pdf" 
                                        filename="labo_report_pdf_filename" 
                                        widget="binary" 
                                        string="PDF du rapport final" readonly="1"/>

                            </group>
                            
                        </group>

                        <group string="Fiche d'Analyse Laboratoire (Générale)">
                            <!-- Afficher la fiche d'analyse générale pour l'édition et la validation du rapport -->
                            <field name="laboratory_analysis_ids" readonly="1" mode="tree,form">
                                <tree>
                                    <field name="name"/>
                                    <field name="analysis_date"/>
                                    <field name="laboratory_id"/>
                                    <field name="state"/>
                                    <field name="result"/>
                                </tree>
                            </field>
                        </group>
                        <group string="Détails des Analyses de Prélèvement par Lot">
                            <field name="prelevement_lot_analysis_ids" readonly="state != 'sampling'" mode="tree,form">
                                <tree>
                                    <!-- Champs typiques pour une ligne de prélèvement/résultat d'analyse -->
                                    <field name="name"/> <!-- Nom/Référence de l'sanalyse du lot -->
                                    <field name="lot_id" string="Lot" domain="[('request_id', '=', id)]"/> <!-- Le lot de production concerné -->
                                    <field name="analyste_lot_id"/> <!-- Le résultat obtenu -->
                                    <field name="result"/> <!-- Conforme/Non-conforme -->
                                    <field name="analysis_date"/> <!-- Date de l'analyse -->
                                </tree>
                            </field>
                        </group>
                    </page>
                        <page string="Certification des lots" >
                            <group string="Lots Conformés (Analyses Terminées et Conformes)">
                                <!-- Utilisation directe du champ Many2many calculé compliant_lots_ids -->
                                <field name="compliant_lots_ids" readonly="state not in ['certification', 'labelling']" mode="tree,form">
                                    <tree string="Lots Conformés">
                                        <field name="name"/>
                                        <field name="area"/>
                                        <field name="state"/>
                                        <field name="inspections_count" string="Nombre d'inspections"/>
                                    </tree>
                                </field>
                            </group>
                        </page>
                        <page string="Certificat délivré" invisible="state not in ['labelling', 'approved']">
                            <group string="Décision finale de certification" col="4">
                                <group colspan="2">
                                    <field name="final_decision_by" readonly="1"/>
                                    <field name="final_decision_date" readonly="1"/>
                                    <field name="final_comment" placeholder="Observations et recommandations..." 
                                        readonly="state == 'approved'"/>
                                </group>
                            </group>

                            <group string="Arrêté final de décision" col="2">
                                <field name="certificate_document" 
                                    filename="certificate_document_filename"
                                    widget="binary" 
                                    string="Arrêté ou décision finale"
                                    readonly="1"
                                    invisible="not certificate_document and state != 'labelling'"/>
                            <field name="certificate_document_filename" invisible="1"/>

                            <group>
                                <button name="preview_document"
                                        string="Prévisualiser l'arrêté"
                                        type="object"
                                        class="oe_highlight"
                                        context="{'document_field': 'certificate_document'}"
                                        invisible="not certificate_document"/>
                            </group>
                        </group>
                    </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>
    
    <!-- Vue liste pour demandes de certification -->
    <record id="view_certification_request_tree" model="ir.ui.view">
        <field name="name">certification.request.tree</field>
        <field name="model">certification.request</field>
        <field name="arch" type="xml">
            <tree string="Demandes de Certification">
                <field name="name"/>
                <field name="operator_id"/>
                <field name="submission_date"/>
                <field name="state" decoration-success="state == 'labelling'" 
                       decoration-warning="state in ('doc_verification', 'inspection', 'sampling', 'certification')"
                       decoration-info="state == 'draft'"
                       decoration-danger="state in ('rejected', 'cancelled')"/>
            </tree>
        </field>
    </record>
    
    <!-- Action pour demandes de certification -->
    <record id="action_certification_request" model="ir.actions.act_window">
        <field name="name">Demandes de Certification</field>
        <field name="res_model">certification.request</field>
        <field name="view_mode">tree,form</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Créer une nouvelle demande de certification
            </p>
        </field>
    </record>
</odoo>