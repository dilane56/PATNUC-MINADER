<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Vue en liste (Tree View) -->
    <record id="fertilizer_renew_homologation_view_tree" model="ir.ui.view">
        <field name="name">fertilizer.renew.homologation.view.tree</field>
        <field name="model">fertilizer.renew.homologation</field>
        <field name="arch" type="xml">
            <tree string="Renouvellement d'Homologation">
                <field name="name"/>
                <field name="arrete_id" 
                    string="Arrêté Initial" 
                    options="{'no_create': True, 'no_open': False}" 
                    domain="[('state', '=', 'expiré')]"/>
                <field name="old_product_hom"/>
                <field name="applicant_id"/>
                <field name="submission_date"/>
                <field name="state" widget="badge"/>
            </tree>
        </field>
    </record>

    <!-- Vue en formulaire (Form View) -->
    <record id="fertilizer_renew_homologation_view_form" model="ir.ui.view">
        <field name="name">fertilizer.renew.homologation.view.form</field>
        <field name="model">fertilizer.renew.homologation</field>
        <field name="arch" type="xml">
            <form string="Renouvellement d'Homologation">
                <header>
                    <!-- Boutons d'AVANCEMENT du Workflow -->
                    <button name="action_submit" string="Soumettre le Dossier" type="object"
                        invisible="state!='draft'" class="oe_highlight" groups="patnuc_minader_homologation_engrais_fertilisants.group_promoteur_demandeur,patnuc_minader_homologation_engrais_fertilisants.group_manager"/>

                    <button name="action_validate_admin" string="Passer à la Vérif. Conformité" type="object"
                        invisible="state!='verification' or not all_documents_verified or not reception_note" class="oe_highlight" groups="patnuc_minader_homologation_engrais_fertilisants.group_agent_SRE,patnuc_minader_homologation_engrais_fertilisants.group_manager"/>

                    <button name="action_start_decision" string="Passer à la Décision" type="object"
                        invisible="state!='validation' or not conformity_complete" class="oe_highlight" groups="patnuc_minader_homologation_engrais_fertilisants.group_agent_DRCQ,patnuc_minader_homologation_engrais_fertilisants.group_manager"/>

                    <button name="action_approve" string="Approuver le Renouvellement" type="object"
                        invisible="state!='decision' or not homologation_arretement or not decision_note" class="oe_highlight" groups="patnuc_minader_homologation_engrais_fertilisants.group_agent_CABINET_MINADER,patnuc_minader_homologation_engrais_fertilisants.group_manager" />

                    <button name="action_sign" string="Finaliser (Certificat Signé)" type="object"
                        invisible="state!='approved' or not homologation_document" class="oe_highlight" groups="patnuc_minader_homologation_engrais_fertilisants.group_agent_CABINET_MINADER"/>

                    <!-- Boutons de RETOUR vers l'étape précédente -->
                    <button name="action_return_to_decision" string="Retour à la Décision" type="object" class="btn-warning"
                        invisible="state!='approved'" groups="patnuc_minader_homologation_engrais_fertilisants.group_agent_DRCQ,patnuc_minader_homologation_engrais_fertilisants.group_manager"/>
                        
                    <button name="action_return_to_validation" string="Retour à la Vérif. Conformité" type="object" class="btn-warning"
                        invisible="state!='decision'" groups="patnuc_minader_homologation_engrais_fertilisants.group_agent_SRE,patnuc_minader_homologation_engrais_fertilisants.group_manager"/>
                        
                    <button name="action_return_to_verification" string="Retour à la reception" type="object" class="btn-warning"
                        invisible="state!='validation'" groups="patnuc_minader_homologation_engrais_fertilisants.group_agent_SRE,patnuc_minader_homologation_engrais_fertilisants.group_manager"/>
                    
                    <button name="action_return_to_draft" string="Retour au Dépôt" type="object" class="btn-warning"
                        invisible="state!='verification'" groups="patnuc_minader_homologation_engrais_fertilisants.group_agent_SRE,patnuc_minader_homologation_engrais_fertilisants.group_manager"/>
                        
                    <!-- Bouton Rejet -->
                    <button name="action_reject" string="Rejeter" type="object" class="btn-danger"
                        invisible="state not in ['verification', 'validation', 'decision', 'approved']" groups="patnuc_minader_homologation_engrais_fertilisants.group_agent_SRE,patnuc_minader_homologation_engrais_fertilisants.group_manager,patnuc_minader_homologation_engrais_fertilisants.group_agent_CABINET_MINADER"/>
                        
                    <field name="state" widget="statusbar" statusbar_visible="draft,verification,validation,decision,approved,signed,rejected"/>
                </header>

                <sheet>
                    <div class="oe_title">
                        <h1><field name="name" readonly="1"/></h1>
                    </div>

                    <group>
                        <group>
                            <field name="arrete_id" 
                                string="Arrêté Initial" 
                                options="{'no_create': True, 'no_open': False}" 
                                domain="[('state', '=', 'expiré')]"/>
                            <field name="old_product_hom" readonly="1"/>
                            <field name="applicant_id" readonly="1"/>     
                        </group>
                        <group>
                            <field name="submission_date" readonly="1"/>              
                        </group>
                    </group>
                    
                    <!-- Affichage du motif de retour si présent et si l'état n'est pas terminé -->
                    <field name="return_reason" readonly="1" invisible="state in ['draft', 'signed', 'rejected'] or not return_reason" string="Motif de retour de l'étape précédente"/>
                    <field name="all_documents_verified" invisible="1"/>
                    
                    <notebook>
                        
                        <!-- TAB 1: Dépôt du Dossier (Editable en 'draft', verrouillé par les règles d'accès ensuite) -->
                        <page string="Documents requis" name="renewal_file">
                            <group string="Documents Officiels et Rapports">
                               
                                <field name="official_request_letter" filename="official_request_letter_filename"/>
                                <field name="official_request_letter_filename" invisible="1" />

                                <field name="report_suivi" filename="report_suivi_filename"/>
                                <field name="report_suivi_filename" invisible="1"/>
                            </group>
                            
                            <group string="Indications Mises à Jour">
                                <field name="data_toxicity"/>
                                <field name="data_environnment"/>
                                <field name="data_limit_max"/>
                            </group>
                        </page>

                        <!-- TAB 2: Vérification Administrative (Editable en 'verification', Visible dès 'verification') -->
                        <page string="Reception du dossier" name="admin_verification" invisible="state in ['draft']">
                            
                            <group string="Vérification des pièces et indications">
                                <!-- Ces champs sont modifiables en 'verification', verrouillés par les règles d'accès ailleurs -->
                                <field name="data_toxicity_verified"/>
                                <field name="data_environnment_verified"/>
                                <field name="data_limit_max_verified"/>
                                <field name="report_suivi_verified"/>
                                <field name="reception_note" placeholder="Commentaire sur la vérification des documents..."/>
                                <field name="reception_agent" readonly="1"/>
                                <field name="reception_date" readonly="1"/>
                            </group>
                        </page>

                        <!-- TAB 3: Vérification de Conformité (Editable en 'validation', Visible dès 'validation') -->
                        <page string="Vérification de Conformité" name="conformity_check" invisible="state in ['draft', 'verification']">
                            <group>
                                <!-- Ces champs sont modifiables en 'validation', verrouillés par les règles d'accès ailleurs -->
                                <field name="conformity_report" filename="conformity_report_filename"/>
                                <field name="conformity_report_filename" invisible="1"/>
                                <field name="conformity_note" placeholder="Note de conformité..."/>
                            </group>
                            
                            <group string="Informations de Vérification">
                                <field name="conformity_complete" 
                                    decoration-success="conformity_complete == True"
                                    decoration-danger="conformity_complete == False"
                                    readonly="1"/>
                                <field name="conformity_check_agent" readonly="1"/>
                                <field name="conformity_check_date" readonly="1"/>
                            </group>
                        </page>

                        <!-- TAB 4: Décision (Editable en 'decision', Visible dès 'decision') -->
                        <page string="Décision de renouvellement" name="decision_page" invisible="state in ['draft', 'verification', 'validation']">
                            <group string="Décision et Arrêté">
                                <!-- Ces champs sont modifiables en 'decision', verrouillés par les règles d'accès ailleurs -->
                                <field name="decision_note" placeholder="Note de décision..."/>
                                
                                <field name="reception_pv" filename="reception_pv_filename"/>
                                <field name="reception_pv_filename" invisible="1"/>

                                <field name="homologation_arretement" filename="homologation_arretement_filename"/>
                                <field name="homologation_arretement_filename" invisible="1"/>

                                <field name="decision_agent" readonly="1"/>
                                <field name="decision_date" readonly="1"/>
                            </group>
                        </page>
                        
                        <!-- TAB 5: Finalisation (Signature) (Editable en 'approved', Visible dès 'approved') -->
                        <page string="Finalisation et Signature" name="signature_page" invisible="state not in ('approved', 'signed')">   
                                <!-- Ce champ est modifiable en 'approved' pour insérer le document signé -->
                                <field name="homologation_document" filename="homologation_document_filename"/>
                                <field name="homologation_document_filename" invisible="1"/>
                                <field name="signature_agent" readonly="1"/>
                                <field name="date_signature" readonly="1"/>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids" widget="mail_followers"/>
                    <field name="message_ids" widget="mail_thread"/>
                </div>
            </form>
        </field>
    </record>

    <!-- Action de Fenêtre -->
    <record id="action_fertilizer_renew_homologation" model="ir.actions.act_window">
        <field name="name">Renouvellement d'Homologation</field>
        <field name="res_model">fertilizer.renew.homologation</field>
        <field name="view_mode">tree,form</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Créer un nouveau dossier de renouvellement d'homologation.
            </p>
        </field>
    </record>
</odoo>
